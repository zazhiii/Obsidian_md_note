
# çº¿ç¨‹

## ä»€ä¹ˆæ˜¯çº¿ç¨‹å’Œè¿›ç¨‹ï¼Ÿ
è¿›ç¨‹ï¼šè¿›ç¨‹æ˜¯ç¨‹åºçš„ä¸€æ¬¡æ‰§è¡Œè¿‡ç¨‹ï¼Œæ˜¯ç³»ç»Ÿè¿è¡Œç¨‹åºçš„åŸºæœ¬å•ä½ã€‚
çº¿ç¨‹ï¼šçº¿ç¨‹æ˜¯æ¯”è¿›ç¨‹æ›´å°çš„æ‰§è¡Œå•ä½ï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥äº§ç”Ÿå¤šä¸ªçº¿ç¨‹ã€‚
>å¤šä¸ªçº¿ç¨‹å…±äº«è¿›ç¨‹çš„**å †**å’Œ**æ–¹æ³•åŒº**èµ„æºï¼Œæ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„**ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆã€æœ¬åœ°æ–¹æ³•æ ˆ**ã€‚

## Java çº¿ç¨‹å’Œæ“ä½œç³»ç»Ÿçº¿ç¨‹çš„å…³ç³»ï¼Ÿ
- ç°åœ¨Javaçš„çº¿ç¨‹æœ¬è´¨å°±æ˜¯æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹ã€‚
- Javaçº¿ç¨‹é‡‡ç”¨ä¸€å¯¹ä¸€çš„çº¿ç¨‹æ¨¡å‹ï¼Œä¸€ä¸ªJavaçº¿ç¨‹å¯¹åº”ä¸€ä¸ªç³»ç»Ÿå†…æ ¸çº¿ç¨‹ã€‚

## çº¿ç¨‹å’Œè¿›ç¨‹çš„å…³ç³»ã€åŒºåˆ«ã€ä¼˜ç¼ºç‚¹ï¼Ÿ
ä¸€ä¸ªè¿›ç¨‹ä¸­æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹å…±äº«è¿›ç¨‹çš„**å †**å’Œ**æ–¹æ³•åŒº**ã€‚
æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„**ç¨‹åºè®¡æ•°å™¨ã€æœ¬åœ°æ–¹æ³•æ ˆã€è™šæ‹Ÿæœºæ ˆ**

- çº¿ç¨‹æ˜¯è¿›ç¨‹åˆ’åˆ†æˆçš„æ›´å°çš„è¿è¡Œå•ä½ã€‚
- è¿›ç¨‹æ˜¯ç‹¬ç«‹çš„ï¼Œçº¿ç¨‹å¯èƒ½äº’ç›¸å½±å“ã€‚çº¿ç¨‹æ‰§è¡Œå¼€é”€å°ï¼Œä½†ä¸åˆ©äºèµ„æºä¿æŠ¤ã€‚è¿›ç¨‹åä¹‹

- ç¨‹åºè®¡æ•°å™¨ï¼šç”¨äºè®°å½•çº¿ç¨‹æ‰§è¡Œçš„ä½ç½®ï¼Œç¡®ä¿åˆ‡æ¢å›æ¥æ—¶èƒ½çŸ¥é“ä¸Šä¸€æ¬¡æ‰§è¡Œåˆ°å“ªé‡Œäº†ã€‚
- è™šæ‹Ÿæœºæ ˆï¼šæ¯ä¸ªæ–¹æ³•åœ¨æ‰§è¡Œå‰ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§æ¥å­˜å‚¨å±€éƒ¨å˜é‡â€¦â€¦ä¿¡æ¯ã€‚æ–¹æ³•è°ƒç”¨åˆ°å®Œæˆå°±å¯¹åº”ä¸€ä¸ªæ ˆå¸§å…¥æ ˆåˆ°å‡ºæ ˆçš„è¿‡ç¨‹ã€‚
- æœ¬åœ°æ–¹æ³•æ ˆï¼šå’Œè™šæ‹Ÿæœºæ ˆç±»ä¼¼ã€‚ä½†è™šæ‹Ÿæœºæ ˆå¯¹åº”Javaæ–¹æ³•ï¼Œæœ¬åœ°æ–¹æ³•æ ˆå¯¹åº”æœ¬åœ°æ–¹æ³•ï¼ˆ`Native`)ã€‚`HotSpot`è™šæ‹Ÿæœºä¸­äºŒè€…åˆäºŒä¸ºä¸€ã€‚

- å †ï¼šå­˜å‚¨åˆ›å»ºå¯¹è±¡çš„å†…å­˜
- æ–¹æ³•åŒºï¼šå­˜å‚¨ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ç­‰ã€‚

## å¦‚ä½•åˆ›å»ºçº¿ç¨‹

ä½¿ç”¨ä»£ç åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼ï¼š
1. ç»§æ‰¿`Thread`ï¼Œå®ç° `run()`ï¼Œè°ƒç”¨ `start()`
2. å®ç°`Runnable`ï¼Œå®ç°`run()`ï¼Œä¼ å…¥`Thread`ï¼Œè°ƒç”¨`start()`
3. å®ç°`Callable`ï¼Œå®ç°`call()`ï¼Œä¼ å…¥`FutureTask`ï¼Œä¼ å…¥`Thread`ï¼Œè°ƒç”¨`start()`

çœŸæ­£åˆ›å»ºçº¿ç¨‹çš„æ—¶åˆ»ï¼š`new Thread().start()`

## Runnable å’Œ Callable åŒºåˆ«
1. Runnable çš„ run æ–¹æ³•æ²¡æœ‰è¿”å›å€¼ï¼ŒCallable çš„ call æ–¹æ³•æœ‰è¿”å›å€¼ï¼Œå’Œ FutureTask é…åˆä½¿ç”¨å¯ä»¥è·å–å¼‚æ­¥æ‰§è¡Œçš„ç»“æœ
2. Callable çš„ call æ–¹æ³•å¯ä»¥å¾€å¤–æŠ›å¼‚å¸¸ï¼ŒRunnable çš„ run æ–¹æ³•ä¸èƒ½å¾€å¤–æŠ›å¼‚å¸¸

## çº¿ç¨‹çŠ¶æ€
NEW åˆå§‹çŠ¶æ€
RUNNABLE å¯è¿è¡ŒçŠ¶æ€
BLOCKED é˜»å¡çŠ¶æ€
WATING ç­‰å¾…çŠ¶æ€
TIME_WATING è¶…æ—¶ç­‰å¾…
TERMINATED ç»ˆç»“çŠ¶æ€

çŠ¶æ€çš„åˆ‡æ¢ï¼š
- åˆ›å»ºçº¿ç¨‹å¯¹è±¡æ˜¯ NEW åˆå§‹çŠ¶æ€
- è°ƒç”¨ `start()` æ–¹æ³•è½¬ä¸º RUNNABLE å¯è¿è¡ŒçŠ¶æ€
	- **æ²¡æœ‰è·å–åˆ°é”**ï¼Œè¿›å…¥ BLOCKED
	- è°ƒç”¨`wait()`è¿›å…¥ WATINGï¼Œå…¶ä»–çº¿ç¨‹è°ƒç”¨`notify()`å¯å°†å®ƒå”¤é†’è‡³ RUNNABLE
	- è°ƒç”¨`sleep(50)`è¿›å…¥ TIME_WATINGï¼Œåˆ°æ—¶é—´ååˆ‡æ¢ä¸º RUNNABLE
- æ‰§è¡Œç»“æŸä¹‹åæ˜¯ TERMINATED ç»ˆæ­¢çŠ¶æ€

## `Thread#sleep()` å’Œ `Object#wait()`æ–¹æ³•å¯¹æ¯”

1. æ–¹æ³•å½’å±ä¸åŒ
	- `sleep(Long time)`æ˜¯`Thread`çš„é™æ€æ–¹æ³•
	- `wait(), wait(Long time)`æ˜¯ `Object`çš„æˆå‘˜æ–¹æ³•ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½æœ‰
2. é†’æ¥æ—¶æœºä¸åŒ
	1. `sleep(Long time), wait(Long time)`ä¼šåœ¨ç­‰å¾…ç›¸åº”æ—¶é—´åé†’æ¥
	2. `wait(), wait(Long time)`å¯ä»¥è¢«`notify()`å”¤é†’ï¼Œä¸å”¤é†’çš„è¯`wait()`ä¼šä¸€ç›´ç­‰å¾…ä¸‹å»
	3. éƒ½å¯ä»¥è¢«æ‰“æ–­å”¤é†’
3. ğŸŒŸé”ç‰¹æ€§ä¸åŒ
	1. `wait()`çš„**è°ƒç”¨å‰**å¿…é¡»è·å–åˆ°`wait`å¯¹è±¡çš„é”ï¼Œ`sleep()`æ— æ­¤é™åˆ¶
	2. `wait()`æ–¹æ³•**å¼€å§‹æ‰§è¡Œå**ä¼šé‡Šæ”¾å¯¹è±¡é”ï¼Œå…¶ä»–çº¿ç¨‹å¯è·å–é”
	3. `sleep()`åœ¨`synchronized`ä¸­å¼€å§‹æ‰§è¡Œåï¼Œä¸ä¼šé‡Šæ”¾å¯¹è±¡é”

```java
// 1. è°ƒç”¨å¯¹è±¡çš„wait()æ–¹æ³•ï¼Œå¿…é¡»è·å–åˆ°å¯¹è±¡çš„é”  
private static void legalWait() throws InterruptedException {  
    synchronized(LOCK){  
        LOCK.wait();  // æ­£å¸¸è¿è¡Œ
    }  
}  
private static void illegalWait() throws InterruptedException {  
    LOCK.wait();  // æŠ¥é”™ï¼šIllegalMonitorStateException: current thread is not owner
}


/**  
 * æ‰§è¡Œç»“æœï¼š  
 * waiting...  // LOCK è°ƒç”¨ wait() é‡Šæ”¾é”  
 * other thread get lock // ä¸»çº¿ç¨‹è·å–åˆ°é”  
 * waiting end // ä¸»çº¿ç¨‹é‡Šæ”¾é”ä¹‹åï¼Œæ–°çº¿ç¨‹è·å–åˆ°é”ï¼Œç»§ç»­æ‰§è¡Œ  
 */  
public static void waiting() throws InterruptedException {  
    new Thread(() -> {  
        synchronized (LOCK) {  
            try {  
                System.out.println("waiting...");  
                LOCK.wait(5000);  
                System.out.println("waiting end");  
            } catch (InterruptedException e) {  
                e.printStackTrace();  
            }  
        }  
    }).start();  
  
    Thread.sleep(1000);  
  
    synchronized (LOCK) {  
        System.out.println("other thread get lock");  
    }  
}


/**  
 * æ‰§è¡Œç»“æœï¼š  
 * sleep...                 // 1. LOCK è°ƒç”¨ sleep() ä½†æ˜¯ã€Œä¸é‡Šæ”¾é”ã€  
 * sleep end                // 2. 5s åï¼ŒLOCK é‡Šæ”¾é”  
 * other thread get lock    // 3. ä¸»çº¿ç¨‹è·å–åˆ°é”  
 */  
public static void sleeping() throws InterruptedException {  
    new Thread(() -> {  
        synchronized (LOCK) {  
            try {  
                System.out.println("sleep...");  
                Thread.sleep(5000);  
                System.out.println("sleep end");  
            } catch (InterruptedException e) {  
                e.printStackTrace();  
            }  
        }  
    }).start();  
  
    Thread.sleep(1000);  
  
    synchronized (LOCK) {  
        System.out.println("other thread get lock");  
    }  
}
```

## run æ–¹æ³•å’Œ start æ–¹æ³•çš„åŒºåˆ«

1. start æ–¹æ³•æ˜¯é€šè¿‡å¼€å¯ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œ run æ–¹æ³•çš„é€»è¾‘ï¼Œåªèƒ½è°ƒç”¨ä¸€æ¬¡ã€‚
2. ç›´æ¥è°ƒç”¨ run æ–¹æ³•ï¼Œç›¸å½“äºè°ƒç”¨ä¸€ä¸ªæ™®é€šæ–¹æ³•ã€‚

# å¤šçº¿ç¨‹

## å¹¶å‘ä¸å¹¶è¡Œ

## åŒæ­¥ä¸å¼‚æ­¥

åŒæ­¥ï¼šè°ƒç”¨åå¿…é¡»ç­‰å¾…ä»»åŠ¡å®Œæˆæ‰è¿”å›ï¼›ä»»åŠ¡é¡ºåºæ‰§è¡Œï¼Œä¸€ä¸ªæ¥ä¸€ä¸ª

å¼‚æ­¥ï¼šè°ƒç”¨åç«‹å³è¿”å›ï¼›ä»»åŠ¡å¹¶è¡Œäº¤é”™æ‰§è¡Œ

## ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¤šçº¿ç¨‹ï¼Ÿ

ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†**æé«˜å¹¶å‘æ€§**ã€**æå‡æ•ˆç‡**å’Œ**å“åº”æ€§**ï¼Œæé«˜ç¨‹åºçš„æ•ˆç‡å’Œå“åº”æ€§

å•æ ¸è§’åº¦ï¼šæé«˜ç¨‹åºä½¿ç”¨CPUå’ŒIOç³»ç»Ÿçš„æ•ˆç‡ï¼ˆIOé˜»å¡æ—¶å»å¤„ç†å…¶ä»–ä»»åŠ¡ï¼‰
å¤šæ ¸è§’åº¦ï¼šæé«˜ç¨‹åºä½¿ç”¨å¤šæ ¸CPUçš„èƒ½åŠ›ï¼ˆå¤šä¸ªCPUåŒæ—¶å¤„ç†ä»»åŠ¡ï¼‰

## å•æ ¸ CPU æ”¯æŒå¤šçº¿ç¨‹å—ï¼Ÿ

æ”¯æŒã€‚

æ“ä½œç³»ç»Ÿé€šè¿‡æ—¶é—´ç‰‡è½®è½¬çš„æ–¹å¼ï¼Œå°† CPU åˆ†é…ç»™ä¸åŒçš„çº¿ç¨‹ã€‚ï¼ˆ CPU åœ¨ä¸åŒçº¿ç¨‹ä¹‹é—´å¿«é€Ÿåˆ‡æ¢ï¼‰

Java çº¿ç¨‹çš„è°ƒåº¦ä½¿ç”¨çš„æ˜¯ï¼šæŠ¢å å¼è°ƒåº¦ã€‚JVM å°†çº¿ç¨‹çš„è°ƒåº¦å§”æ‰˜ç»™æ“ä½œç³»ç»Ÿï¼Œæ“ä½œç³»ç»ŸåŸºäºçº¿ç¨‹ä¼˜å…ˆçº§å’Œæ—¶é—´ç‰‡æ¥è°ƒåº¦çº¿ç¨‹çš„æ‰§è¡Œ


## å•æ ¸ CPU è¿è¡Œå¤šçº¿ç¨‹ æ•ˆç‡ä¸€å®šä¼šæ›´é«˜å—ï¼Ÿ

ä¸ä¸€å®šã€‚å¾—çœ‹ä»»åŠ¡çš„æ€§è´¨ã€‚

**CPU å¯†é›†å‹**ï¼šå•æ ¸ CPU åªèƒ½è¿è¡Œä¸€ä¸ªçº¿ç¨‹ï¼Œå¤šçº¿ç¨‹ä¼šå¯¼è‡´çº¿ç¨‹é—´åˆ‡æ¢ï¼Œå¢åŠ ç³»ç»Ÿå¼€é”€ï¼Œ**é™ä½æ•ˆç‡**

**I/O å¯†é›†å‹**ï¼šCPU åœ¨ç­‰å¾…çº¿ç¨‹ I/Oçš„æ—¶å€™å¯ä»¥åˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹å¤„ç†ä»»åŠ¡ï¼Œ**æé«˜æ•ˆç‡**

## å¹¶å‘ç¼–ç¨‹å¸¦æ¥çš„é—®é¢˜

å†…å­˜æ³„éœ²ã€çº¿ç¨‹ä¸å®‰å…¨ã€æ­»é”â€¦â€¦

## å¦‚ä½•ç†è§£çº¿ç¨‹å®‰å…¨å’Œçº¿ç¨‹ä¸å®‰å…¨

åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯¹å…±äº«æ•°æ®çš„è®¿é—®èƒ½å¦ä¿è¯æ­£ç¡®æ€§

# æ­»é”
## ä»€ä¹ˆæ˜¯æ­»é”ï¼Ÿ

ä¸¤ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œ**äº’ç›¸ç­‰å¾…å¯¹æ–¹æŒæœ‰çš„èµ„æº**ï¼Œå¯¼è‡´çº¿ç¨‹æ°¸ä¹…é˜»å¡

## äº§ç”Ÿæ­»é”çš„æ¡ä»¶ï¼ˆå››ä¸ªï¼‰ï¼š

1. äº’æ–¥æ¡ä»¶ï¼šèµ„æºåªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€å æœ‰

2. è¯·æ±‚ä¸ä¿æŒæ¡ä»¶ï¼šçº¿ç¨‹åœ¨è¯·æ±‚èµ„æºè€Œè¢«é˜»å¡çš„æ—¶å€™ï¼Œä¿æŒèµ„æºä¸æ”¾ã€‚

3. ä¸å¯å‰¥å¤ºæ¡ä»¶ï¼šçº¿ç¨‹åœ¨ä½¿ç”¨å®Œèµ„æºæ—¶ï¼Œä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹å‰¥å¤º

4. å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼šè‹¥å¹²çº¿ç¨‹çº¿ç¨‹ä¸€ç§å¤´å°¾ç›¸è¿çš„ç­‰å¾…èµ„æºå…³ç³»

## å¦‚ä½•æ£€æµ‹æ­»é”ï¼Ÿ

ä½¿ç”¨`JConsole`å·¥å…·

## å¦‚ä½•é¢„é˜²å’Œé¿å…æ­»é”ï¼Ÿ

>ç ´åæ­»é”çš„æ¡ä»¶ä¹‹ä¸€å°±å¯ä»¥é¿å…æ­»é”

1. ç ´åè¯·æ±‚ä¸ä¿æŒæ¡ä»¶ï¼šä¸€æ¬¡æ€§ç”³è¯·æ‰€æœ‰çš„èµ„æºï¼Œé¿å…æŒæœ‰ä¸€éƒ¨åˆ†èµ„æºç„¶åå†å»ç”³è¯·èµ„æº

2. ç ´åä¸å¯å‰¥å¤ºæ¡ä»¶ï¼šåŠ é”æ—¶è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œç”³è¯·ä¸åˆ°èµ„æºå°±é‡Šæ”¾åŸæ¥çš„èµ„æº

3. ç ´åå¾ªç¯ç­‰å¾…ï¼šæŒ‰é¡ºåºç”³è¯·èµ„æº

# ============

# JMM(Java Memory Model)

Java å†…å­˜æ¨¡å‹

Java æ²¡æœ‰å¤ç”¨æ“ä½œç³»ç»Ÿçš„å†…å­˜æ¨¡å‹ï¼Œè€Œæ˜¯è‡ªå·±æä¾›ä¸€å¥—å†…å­˜æ¨¡å‹å±è”½äº†ç³»ç»Ÿå·®å¼‚æ€§ï¼ˆè·¨å¹³å°ï¼‰

JMM å¯ä»¥çœ‹ä½œ Java å¹¶å‘ç¼–ç¨‹çš„ä¸€ç§è§„èŒƒã€‚ä»–è§„å®šäº†**çº¿ç¨‹å’Œä¸»å†…å­˜çš„å…³ç³»**ã€è§„å®š Java ä»æºä»£ç åˆ° CPU æŒ‡ä»¤éœ€è¦éµå®ˆçš„è§„åˆ™ã€‚ç›®çš„æ˜¯ä¸ºäº†é¿å… CPU çš„æŸäº›è®¾è®¡å¯¼è‡´ Java å¤šçº¿ç¨‹æ‰§è¡Œå‡ºç°é—®é¢˜ ã€‚

# `volatile`

## `volatile`çš„ä½œç”¨ï¼Ÿ

ä¿è¯å…±äº«å˜é‡çš„**å¯è§æ€§**

## ä¿è¯å¯è§æ€§çš„åŸç†

é€šè¿‡**è¯»å†™å±éšœ**ã€é˜²æ­¢ CPU æŒ‡ä»¤é‡æ’

å†™å±éšœï¼šå½“çº¿ç¨‹å†™å…¥å˜é‡ä¹‹åï¼Œå¼ºåˆ¶å°†å˜é‡å†™å…¥ä¸»å­˜

è¯»å±éšœï¼šå½“çº¿ç¨‹è¯»å–å˜é‡ä¹‹å‰ï¼Œå¼ºåˆ¶ä»ä¸»å­˜ä¸­è¯»å–æœ€æ–°å€¼

è¯»å†™å±éšœä¹‹é—´ä¸èƒ½ä¹±åºæ‰§è¡Œ

## `volatile`åº”ç”¨

åŒé‡æ ¡éªŒé”å®ç°å•ä¾‹æ¨¡å¼
```java
public class Singleton {

    private volatile static Singleton uniqueInstance;

    private Singleton() {
    }

    public  static Singleton getUniqueInstance() {
       //å…ˆåˆ¤æ–­å¯¹è±¡æ˜¯å¦å·²ç»å®ä¾‹è¿‡ï¼Œæ²¡æœ‰å®ä¾‹åŒ–è¿‡æ‰è¿›å…¥åŠ é”ä»£ç 
        if (uniqueInstance == null) {
            //ç±»å¯¹è±¡åŠ é”
            synchronized (Singleton.class) {
                if (uniqueInstance == null) {
                    uniqueInstance = new Singleton();
                }
            }
        }
        return uniqueInstance;
    }
}
```

## å¯ä»¥ä¿è¯åŸå­æ€§å—ï¼Ÿ

ä¸èƒ½ï¼›`synchronized`å¯ä»¥ä¿è¯å¯è§æ€§å’ŒåŸå­æ€§


# ä¹è§‚é”å’Œæ‚²è§‚é”

## ä»€ä¹ˆæ˜¯æ‚²è§‚é”ï¼Ÿ

è®¤ä¸ºçº¿ç¨‹å®‰å…¨é—®é¢˜ä¸€å®šä¼šå‡ºç°ï¼Œæ¯æ¬¡æ“ä½œèµ„æºéƒ½ä¸Šé”ã€‚å…±äº«èµ„æºæ¯æ¬¡éƒ½ç»™ä¸€ä¸ªäººç”¨ï¼Œå…¶ä»–çº¿ç¨‹é˜»å¡ï¼Œç”¨å®Œå†è½¬è®©ã€‚

>`synchronized` å’Œ `ReentrantLock`éƒ½æ˜¯æ‚²è§‚é”

## ä»€ä¹ˆæ˜¯ä¹è§‚é”ï¼Ÿ

è®¤ä¸ºçº¿ç¨‹å®‰å…¨é—®é¢˜**ä¸ä¸€å®š**ä¼šå‡ºç°ï¼Œè®¿é—®å…±äº«èµ„æºæ—¶ä¸åŠ é”ï¼›

åœ¨æäº¤ä¿®æ”¹æ—¶éªŒè¯æ•°æ®åœ¨æ­¤æœŸé—´æ˜¯å¦è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼Œå¦‚æœæœ‰å°±æ”¾å¼ƒä¿®æ”¹æˆ–è€…é‡è¯•

å…·ä½“åšæ³•æœ‰**ç‰ˆæœ¬å·æœºåˆ¶**å’Œ**CASç®—æ³•**

>ä¹è§‚é”æ²¡æœ‰çœŸæ­£åŠ é”ï¼Œä¸ä¼šé˜»å¡çº¿ç¨‹ï¼Œä¸€å®šç¨‹åº¦ä¸Šæ€§èƒ½æ›´å¥½ã€‚
>ä½†æ˜¯å¦‚æœæ•°æ®ä¿®æ”¹é¢‘ç¹ï¼Œä¼šå¯¼è‡´æ“ä½œé¢‘ç¹é‡è¯•å’Œå¤±è´¥ï¼Œä¹Ÿä¼šä¸¥é‡å½±å“æ€§èƒ½ã€‚
>
>æ‰€ä»¥ç†è®ºä¸Šï¼š
>- æ‚²è§‚é”ç”¨äº **å†™å¤š** çš„åœºæ™¯
>- ä¹è§‚é”ç”¨äº **è¯»å¤š** çš„åœºæ™¯

## å¦‚ä½•å®ç°ä¹è§‚é”ï¼Ÿ

1. ç‰ˆæœ¬å·æœºåˆ¶

æ¯”å¯¹æäº¤ä¿®æ”¹æ—¶çš„ç‰ˆæœ¬å·å’Œè¯»å–æ—¶çš„ç‰ˆæœ¬å·

2. CASç®—æ³•ï¼ˆä½¿ç”¨ç›¸å¯¹è¾ƒå¤šï¼‰

>Compare And Swap / Set

æ‹¿æäº¤ä¿®æ”¹æ—¶çš„å½“å‰æ•°æ®å€¼å’ŒæœŸæœ›çš„æ•°æ®ï¼ˆä¸€èˆ¬å°±æ˜¯ä¸€å¼€å§‹è¯»å–åˆ°çš„æ•°æ®å€¼ï¼‰å€¼æ¯”è¾ƒï¼Œç›¸åŒåˆ™æ²¡æœ‰å…¶ä»–çº¿ç¨‹åœ¨æ­¤æœŸé—´ä¿®æ”¹å˜é‡ï¼Œä¿®æ”¹æˆåŠŸï¼Œå¦åˆ™ä¿®æ”¹å¤±è´¥ã€‚

## Javaå¦‚ä½•å®ç°CASçš„ï¼Ÿ

é€šè¿‡`Unsafe`ç±»çš„æœ¬åœ°æ–¹æ³•ï¼ˆ`native`æ–¹æ³•ï¼‰å®ç°

è¿™äº›æ–¹æ³•åœ¨ç¡¬ä»¶å±‚é¢å®ç°åŸå­æ€§

## CASç®—æ³•æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ

1. ABAé—®é¢˜
å½“ä¸€ä¸ªå˜é‡åœ¨CASæœŸé—´è¢«ä¿®æ”¹å¹¶å†è¢«ä¿®æ”¹å›æ¥æ—¶CASæ˜¯æ— æ³•æ£€æµ‹åˆ°çš„ã€‚å¯ä»¥é€šè¿‡ç‰ˆæœ¬å·è§£å†³

2. CASå¤±è´¥ä¼šå¾ªç¯é‡è¯•ï¼ˆ**è‡ªæ—‹**ï¼‰ï¼Œé‡è¯•è¿‡å¤šä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜

3. åªèƒ½æ“ä½œä¸€ä¸ªå…±äº«å˜é‡


# `synchronized`

## `synchronized`æ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ

`synchronized`æ˜¯ä¸€ä¸ªå…³é”®å­—ã€‚

ä»–èƒ½ä¿è¯å¤šçº¿ç¨‹è®¿é—®èµ„æºçš„**åŒæ­¥æ€§**

ä¿è¯è¢«ä»–ä¿®é¥°çš„**æ–¹æ³•æˆ–ä»£ç å—**åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ

## å¦‚ä½•ä½¿ç”¨

1. ä¿®é¥°æ–¹æ³•
	1. ä¿®é¥°é™æ€æ–¹æ³•ï¼ˆé”å½“å‰ç±»å¯¹è±¡ï¼‰
	2. ä¿®é¥°å®ä¾‹æ–¹æ³•ï¼ˆé”å½“å‰å®ä¾‹å¯¹è±¡ï¼‰
2. ä¿®é¥°ä»£ç å—ï¼ˆé”æ‹¬å·å†…çš„å¯¹è±¡ï¼‰

## `sychronized`åŸç†
[[å¹¶å‘ç¼–ç¨‹#`synchronized`ç®€å•åŸç†]]
[[å¹¶å‘ç¼–ç¨‹#`synchronized` è¿›é˜¶åŸç†]]

## JDK1.6 ä¹‹åçš„ synchronized åº•å±‚åšäº†å“ªäº›ä¼˜åŒ–ï¼Ÿé”å‡çº§åŸç†ï¼Ÿ

- åå‘é”
- è½»é‡çº§é”
- é”è‡ªæ—‹
- é”æ¶ˆé™¤

é”ä¸»è¦å­˜åœ¨å››ç§çŠ¶æ€ï¼Œä¾æ¬¡æ˜¯ï¼šæ— é”çŠ¶æ€ã€åå‘é”çŠ¶æ€ã€è½»é‡çº§é”çŠ¶æ€ã€é‡é‡çº§é”çŠ¶æ€ï¼Œä»–ä»¬ä¼šéšç€ç«äº‰çš„æ¿€çƒˆè€Œé€æ¸å‡çº§ã€‚

æ³¨æ„**é”å¯ä»¥å‡çº§ä¸å¯é™çº§**ï¼Œè¿™ç§ç­–ç•¥æ˜¯ä¸ºäº†æé«˜è·å¾—é”å’Œé‡Šæ”¾é”çš„æ•ˆç‡ã€‚

## `synchronized`å’Œ`volatile`çš„åŒºåˆ«

- `volatile`ä¿è¯æ•°æ®å¯è§æ€§ï¼Œä¸ä¿è¯åŸå­æ€§ï¼›`synchronized`ä¿è¯å¯è§æ€§å’ŒåŸå­æ€§
- `volatile`ä¿®é¥°å˜é‡ï¼›`synchronized`ä¿®é¥°æ–¹æ³•æˆ–ä»£ç å—
- `volatile`ä¸»è¦è§£å†³çº¿ç¨‹ä¹‹é—´çš„


## `ReentrantLock`

>ç±»ä¼¼`synchronized`çš„å¯é‡å…¥é”ï¼Œæ›´å¼ºå¤§è·Ÿçµæ´»

## `synchronized`å’Œ`ReentrantLock`å¯¹æ¯”

1. éƒ½æ˜¯å¯é‡å…¥é”
2. `synchronized`åœ¨JVMå±‚é¢å®ç°ï¼›`ReentrantLock`æ˜¯åœ¨Javaå±‚é¢å®ç°çš„ï¼ˆä¾èµ–JavaAPIï¼‰
3. `ReentrantLock`å¢åŠ æ›´å¤šåŠŸèƒ½
	1. ç­‰å¾…å¯ä¸­æ–­
	2. å¯å®ç°å…¬å¹³é”
	3. é€‰æ‹©æ€§é€šçŸ¥ï¼ˆConditionï¼‰
	4. è¶…æ—¶è·å–é”

# ======

# `ThreadLocal`
## `ThreadLocal`ä½œç”¨ï¼Ÿ

ä¸ºæ¯ä¸ªçº¿ç¨‹æä¾›è‡ªå·±ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬

ThreadLocal æœ¬è´¨æ˜¯çº¿ç¨‹å†…éƒ¨å­˜å‚¨ç±»ï¼Œä»è€Œè®©å¤šä¸ªçº¿ç¨‹åªæ“ä½œè‡ªå·±å†…éƒ¨çš„å€¼ï¼Œä»è€Œå®ç°çº¿ç¨‹æ•°æ®éš”ç¦»ã€‚

## åŸç†

æ¯ä¸ªçº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤äº†ä¸€ä¸ª`ThreadLocalMap`ï¼Œå®ƒå¯ä»¥çœ‹ä½œä¸€ä¸ªå®šåˆ¶ç‰ˆ`HashMap`

![[ThreadLocalåŸç†.png]]

å½“è°ƒç”¨`ThreadLocal`çš„`set(T value)`æ—¶ï¼š
1. é€šè¿‡`Thread.currentThread()`æ‹¿åˆ°å½“å‰çº¿ç¨‹ï¼Œè¿›è€Œæ‹¿åˆ°å½“å‰çº¿ç¨‹ç»´æŠ¤çš„`ThreadLocalMap`
2. ä»¥å½“å‰`ThreadLocal`å¯¹è±¡ä½œä¸ºkeyï¼Œå°†valueå­˜å…¥`ThreadLocalMap`ä¸­

å½“è°ƒç”¨`get()`æ—¶ç±»ä¼¼ã€‚

## å†…å­˜æ³„éœ²æ˜¯å¦‚ä½•é€ æˆçš„ï¼Ÿ

å…ˆçœ‹`ThreadLocalMap`ä¸­å­˜å‚¨æ•°æ®`Entry`ç»“æ„

```java
static class Entry extends WeakReference<ThreadLocal<?>> {
	// æ²¡æœ‰ä½¿ç”¨ ThreadLocal key; è¿™æ ·çš„å¼ºå¼•ç”¨ã€‚
    Object value;
}
```

`ThreadLocalMap`çš„ **key æ˜¯å¼±å¼•ç”¨**ï¼Œvalueæ˜¯å¼ºå¼•ç”¨ã€‚

> å¹¶æ²¡æœ‰ä½¿ç”¨ `ThreadLocal key;` è¿™æ ·çš„å¼ºå¼•ç”¨ï¼Œè€Œæ˜¯é€šè¿‡ `WeakReference`å®ç°å¼±å¼•ç”¨

å½“`ThreadLocal`å®ä¾‹æ²¡æœ‰è¢«å¼ºå¼•ç”¨æ‰€æŒ‡å‘æ—¶ï¼ˆæ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨å®Œ tl ä¹‹åæŠŠå®ƒèµ‹å€¼ä¸º nullï¼‰ï¼Œå®ä¾‹å°±ä¼šè¢«GCï¼Œæ­¤æ—¶ key å˜ä¸º `null`ã€‚

ä½†å­˜å‚¨çš„å¯¹è±¡ä»ç„¶è¢«`ThreadLocalMap.Entry`ä¸­çš„`value`æ‰€æŒ‡å‘ï¼Œæ— æ³•è¢«GCï¼Œæˆ‘ä»¬ä¹Ÿæ— æ³•è®¿é—®åˆ°è¿™ä¸ª`value`ï¼Œæœ€åå°±é€ æˆäº†å†…å­˜æ³„éœ²ã€‚

å¦‚æœ**çº¿ç¨‹ç»§ç»­å­˜æ´»**ï¼ˆçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ï¼‰ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆå†…å­˜æ³„éœ²ã€‚

> ä¸ºä»€ä¹ˆè¦è®¾è®¡æˆå¼±å¼•ç”¨ï¼Ÿ
> é¿å…æ›´ä¸¥é‡çš„å†…å­˜æ³„éœ²ï¼Œå¦‚æœ key è®¾è®¡ä¸ºå¼ºå¼•ç”¨ï¼Œå½“å¤–éƒ¨ä¸åœ¨å¼•ç”¨ tl å®ä¾‹çš„æ—¶å€™ï¼Œkey ä»ç„¶å¼ºå¼•ç”¨ tl å®ä¾‹ï¼Œè¿™å°±å¯¼è‡´è¿ key éƒ½æ— æ³•è¢« GC äº†ï¼Œé€ æˆäº†æ›´ä¸¥é‡çš„æ³„éœ²ã€‚
## å¦‚ä½•é¿å…å†…å­˜æ³„éœ²ï¼Ÿ

ç”¨å®Œä¹‹åè°ƒç”¨`ThreadLocal`å®ä¾‹çš„ `remove()`æ–¹æ³•

## å¦‚ä½•è·¨çº¿ç¨‹ä¼ é€’`ThreadLocal`çš„å€¼ï¼Ÿ

1. `InheritableThreadLocal`ï¼šJDK1.2æä¾›çš„å·¥å…·ï¼Œå½“åˆ›å»ºå­çº¿ç¨‹ä¹‹åï¼Œä»–ä¼šç»§æ‰¿çˆ¶çº¿ç¨‹ä¸­`ThreadLocal`çš„å€¼ï¼Œä½†æ˜¯æ— æ³•åœ¨çº¿ç¨‹æ± çš„åœºæ™¯ä¸‹åšåˆ°å€¼ä¼ é€’

2. `TransmittableThreadLocal`ï¼šé˜¿é‡Œå·´å·´å¼€æºå·¥å…·ï¼Œå¯ä»¥å®ç°çº¿ç¨‹æ± ä¸‹å®ç°å€¼ä¼ é€’


# çº¿ç¨‹æ± 

## å¦‚ä½•åˆ›å»ºçº¿ç¨‹æ± 

1. ä½¿ç”¨`ThreadPoolExecutor`æ„é€ å‡½æ•°åˆ›å»ºï¼ˆæ¨èï¼‰
2. ä½¿ç”¨`Executors`åˆ›å»º

## ä¸ºä»€ä¹ˆä¸æ¨èä½¿ç”¨ Executors åˆ›å»ºçº¿ç¨‹æ± 

åˆ›å»ºçš„çº¿ç¨‹æ± éƒ½æœ‰ä¸€å®šå¼Šç«¯

## çº¿ç¨‹æ± çš„æ ¸å¿ƒå‚æ•°

1. æ ¸å¿ƒçº¿ç¨‹æ•°
2. æœ€å¤§çº¿ç¨‹æ•°
3. ä¸´æ—¶çº¿ç¨‹å­˜æ´»æ—¶é—´
4. ä¸´æ—¶çº¿ç¨‹å­˜æ´»æ—¶é—´å•ä½
5. ä»»åŠ¡é˜Ÿåˆ—
6. åˆ›å»ºçº¿ç¨‹çš„å·¥å‚ç±»
7. ä»»åŠ¡æ‹’ç»ç­–ç•¥

>é€šè¿‡è‡ªå®šä¹‰çº¿ç¨‹å·¥å‚ï¼Œå¯ä»¥å®ç°ç»™çº¿ç¨‹å‘½å

```java
//æ„é€ å™¨ï¼Œå‚æ•°æ˜¯é‡ç‚¹
public ThreadPoolExecutor(
			int corePoolSize, // æ ¸å¿ƒçº¿ç¨‹æ•°é‡
			int maximumPoolSize, // æœ€å¤§çº¿ç¨‹æ•°é‡(æœ€å¤§çº¿ç¨‹æ•° = æ ¸å¿ƒçº¿ç¨‹æ•° + ä¸´æ—¶çº¿ç¨‹æ•°)
			long keepAliveTime, // ä¸´æ—¶çº¿ç¨‹çš„å­˜æ´»æ—¶é—´
			TimeUnit unit, // ä¸´æ—¶çº¿ç¨‹çš„å­˜æ´»æ—¶é—´å•ä½
			BlockingQueue<Runnable> workQueue, // ä»»åŠ¡é˜Ÿåˆ—
			ThreadFactory threadFactory, // çº¿ç¨‹å·¥å‚
			RejectedExecutionHandler handler // ä»»åŠ¡æ‹’ç»ç­–ç•¥
)
```

## å¦‚ä½•ç¡®å®šæ ¸å¿ƒçº¿ç¨‹æ•°

IOå¯†é›†å‹ä»»åŠ¡ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°å¤§å°è®¾ç½®ä¸º $2N + 1$

CPUå¯†é›†å‹ä»»åŠ¡ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°å¤§å°è®¾ç½®ä¸º $N+1$

## çº¿ç¨‹æ± çš„æ‹’ç»ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ

1. è°ƒç”¨è€…æŠ›å¼‚å¸¸ï¼ˆé»˜è®¤ï¼‰`AbortPolicy`
2. ä½¿ç”¨ä¸»çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ `CallerRunsPolicy`
3. ä¸¢å¼ƒé˜»å¡é˜Ÿåˆ—ä¸­æœ€å‰çš„ä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œå½“å‰ä»»åŠ¡ `DiscardOldestPolicy`
4. ç›´æ¥ä¸¢å¼ƒä»»åŠ¡ `DiscardPolicy`


## çº¿ç¨‹æ± ä¸­æœ‰å“ªäº›å¸¸è§é˜»å¡é˜Ÿåˆ—

1. `ArrayBlockingQueue` åŸºäºæ•°ç»„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼ŒFIFO
2. `LinkedBlockingQueue`åŸºäºé“¾è¡¨çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼ŒFIFO

åŒºåˆ«ï¼š

| `ArrayBlockingQueue` | `LinkedBlockingQueue`ï¼ˆå¼€å‘ä¸­è¿ç”¨æ›´å¤šï¼‰         |
| -------------------- | -------------------------------------- |
| å¼ºåˆ¶æœ‰ç•Œ                 | é»˜è®¤æ— ç•Œï¼ˆ`Integer.MAX_VALUE`ï¼‰ï¼Œæ”¯æŒæœ‰ç•Œï¼ˆæ¨èè®¾ç½®ç•Œé™ï¼‰ |
| åº•å±‚æ˜¯æ•°ç»„                | åº•å±‚æ˜¯é“¾è¡¨                                  |
| æå‰åˆå§‹åŒ– Node æ•°ç»„        | æ˜¯æ‡’æƒ°çš„ï¼Œåˆ›å»ºèŠ‚ç‚¹çš„æ—¶å€™ç”Ÿæˆ Nodeï¼Œæ·»åŠ æ•°æ®               |
| **å‡ºé˜Ÿå’Œå…¥é˜Ÿæ˜¯ä¸€æŠŠé”ï¼ˆæ•ˆç‡æ›´ä½ï¼‰**  | **å‡ºé˜Ÿå’Œå…¥é˜Ÿæ˜¯ä¸¤æŠŠé”ï¼ˆæ•ˆç‡æ›´é«˜ï¼‰**                    |

## çº¿ç¨‹æ± çš„æ‰§è¡ŒåŸç†

1. æäº¤ä»»åŠ¡ï¼Œåˆ¤æ–­æ ¸å¿ƒçº¿ç¨‹æ˜¯å¦å·²æ»¡ã€‚å¦ï¼Œåˆ™æ·»åŠ ä»»åŠ¡åˆ°æ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œã€‚
2. æ˜¯ï¼Œåˆ™åˆ¤æ–­é˜»å¡é˜Ÿåˆ—æ˜¯å¦å·²æ»¡ã€‚é˜»å¡é˜Ÿåˆ—æ²¡æ»¡åˆ™æ·»åŠ ä»»åŠ¡åˆ°é˜»å¡é˜Ÿåˆ—ä¸­
3. é˜»å¡é˜Ÿåˆ—æ»¡äº†åˆ™åˆ¤æ–­çº¿ç¨‹æ•°æ˜¯å¦å°äºç­‰äºæœ€å¤§çº¿ç¨‹æ•°ã€‚æ˜¯ï¼Œåˆ™åˆ›å»ºä¸´æ—¶çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚
4. è‹¥çº¿ç¨‹æ•°ä¹Ÿè¾¾åˆ°äº†æœ€å¤§çº¿ç¨‹æ•°ï¼Œåˆ™ä½¿ç”¨æ‹’ç»ç­–ç•¥å¤„ç†ä»»åŠ¡ã€‚

## çº¿ç¨‹é‡åˆ°å¼‚å¸¸ä¹‹åä¼šå¤ç”¨è¿˜æ˜¯é”€æ¯?

- `execute()`æäº¤çš„ä»»åŠ¡å‡ºç°æœªæ•è·çš„å¼‚å¸¸åˆ™**ä¼šç»ˆæ­¢çº¿ç¨‹**
- `submit()`æäº¤çš„ä»»åŠ¡ä¼šå°†å¼‚å¸¸å°è£…åˆ°`Future`ä¸­ï¼Œ**ä¸ä¼šç»ˆæ­¢çº¿ç¨‹**

## å¦‚ä½•ç»™çº¿ç¨‹æ± å‘½åï¼Ÿ

è‡ªå·±å®ç°`ThreadFactory`


# `Future`

## `Future`çš„ä½œç”¨ï¼Ÿ

ä½¿ç”¨`Future`å¼‚æ­¥å»æ‰§è¡Œä»»åŠ¡ï¼Œå¹¶å¯ä»¥è·å–æ‰§è¡Œç»“æœã€‚

## `CompletableFutrue`çš„ä½œç”¨ï¼Ÿ

å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ï¼Œè·å–æ‰§è¡Œç»“æœï¼›æä¾›å‡½æ•°å¼ç¼–ç¨‹ï¼Œå¼‚æ­¥ä»»åŠ¡ç¼–æ’


# `AQS`

>`AbstractQueueSynchronizer` æŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨

